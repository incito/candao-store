<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->
<mapper namespace="com.candao.www.data.dao.WaiterShiftDao">

	<select id="getOrderInfoGroupByOrder" parameterType="java.util.Map"  resultType="java.util.Map">
		SELECT too.orderid AS orderId,
			tt.tableNo AS tableNo,
			too.custnum AS custNum,
			SUM(tod.dishnum*tod.orignalprice) AS shouldAmount
 		FROM t_order_detail tod
 		LEFT JOIN t_order too ON tod.orderid = too.orderid
 		LEFT JOIN t_table AS tt ON tt.tableid = too.currenttableid
 		WHERE too.userid = #{userid}
 		AND too.orderstatus=3
 		AND too.branchid = #{branchId}
 		AND too.begintime >= #{beginTime}
 		AND too.begintime &lt;= #{endTime}
 		AND (tod.dishtype &lt;> 2 or (tod.primarykey &lt;> tod.superkey and tod.dishtype = 2))
 		<if test="shiftid==-1">
	    AND too.shiftid IN (0,1)
	    </if>
	    <if test="shiftid!=-1">
		AND too.shiftid = #{shiftid}
		</if>
 		GROUP BY too.orderid
 		ORDER BY orderId ASC
	</select>
	<select id="getOrderSettlementInfoDetail" parameterType="java.util.Map"  resultType="java.util.Map">
		SELECT too.orderid AS orderId,
			td.itemid AS itemId,
			td.itemDesc AS itemDesc,
			tsd.payamount AS actualAmount
 		FROM t_settlement_detail tsd 
 		LEFT JOIN t_order too ON too.orderid = tsd.orderid
 		LEFT JOIN t_dictionary td ON td.itemid = tsd.payway
 		WHERE too.userid = #{userid}
 		AND too.orderstatus=3
 		AND too.branchid = #{branchId}
 		AND too.begintime >= #{beginTime}
 		AND too.begintime &lt;= #{endTime}
 		AND tsd.payway IN (SELECT itemid FROM v_revenuepayway)
 		AND td.type='PAYWAY'
 		<if test="shiftid==-1">
	    AND too.shiftid IN (0,1)
	    </if>
	    <if test="shiftid!=-1">
		AND too.shiftid = #{shiftid}
		</if>
 		GROUP BY tsd.payway,too.orderid
 		ORDER BY orderId ASC ,td.itemSort ASC
	</select>
	<select id="getSettlementInfo"  resultType="java.util.Map">
		SELECT itemid as itemId,itemDesc as itemDesc FROM v_revenuepayway where itemid not in(13,30) order by itemSort asc
	</select>
	<select id="getOrderInflateInfo" parameterType="java.util.Map"  resultType="java.util.Map">
		SELECT too.userid as waiterId,
			SUM(tom.inflated) as inflate
		FROM t_order_member tom
		LEFT JOIN t_order too ON too.orderid = tom.orderid
		WHERE too.branchid = #{branchId}
		AND too.begintime >= #{beginTime}
		AND too.begintime &lt;= #{endTime}
		AND too.orderstatus = 3
		<if test=" userid != null and userid!='' ">
	    AND too.userid =#{userid}
	    </if>
	    <if test="shiftid != null and shiftid != -1">
	    AND too.shiftid = #{shiftid}
	    </if>
		GROUP BY too.userid
		ORDER BY waiterId asc
	</select>
	<select id="getOrderSettlementInfo" parameterType="java.util.Map"  resultType="java.util.Map">
    	SELECT SUM(tsd.payamount) as actualAmount,
    		too.userid as waiterId,
    		td.itemDesc as itemDesc,
    		td.itemid as itemId
		FROM t_settlement_detail AS tsd 
		LEFT JOIN t_order AS too ON tsd.orderid = too.orderid
		LEFT JOIN t_dictionary td ON td.itemid = tsd.payway
		WHERE too.branchid = #{branchId}
		AND too.begintime >= #{beginTime}
		AND too.begintime &lt;= #{endTime}
		<if test=" userid != null and userid!='' ">
	    AND too.userid =#{userid}
	    </if>
	    <if test="shiftid != null and shiftid != -1">
	    AND too.shiftid = #{shiftid}
	    </if>
	    AND too.orderstatus = 3
		AND td.itemid IN(SELECT itemid FROM v_revenuepayway)
		AND td.type = 'PAYWAY'
		GROUP BY tsd.payway,too.userid
		ORDER BY waiterId asc,td.itemSort asc
    </select>
    <select id="getOrderInfoGroupByWaiter" parameterType="java.util.Map"  resultType="java.util.Map">
    	SELECT * 
		FROM (SELECT tooo.userid AS waiterId,
				us.name AS waiterName,
				COUNT(DISTINCT(tooo.orderid)) AS tableNum,
				SUM(tod.dishnum*tod.orignalprice) AS shouldAmount
			  FROM (SELECT * FROM t_order as too 
			  		WHERE too.branchid = #{branchId}
			  		AND too.begintime >= #{beginTime}
			  		AND too.begintime &lt;= #{endTime}
			  		AND too.orderstatus=3
			  		<if test=" userid != null and userid!='' ">
	      			AND too.userid =#{userid}
	   				</if>
	    			<if test="shiftid != null and shiftid!=-1">
					AND too.shiftid = #{shiftid}
					</if>) AS tooo
		      LEFT JOIN t_b_employee em ON tooo.userid = em.job_number 
			  LEFT JOIN t_b_user us ON us.id = em.user_id
		      LEFT JOIN t_order_detail tod ON tod.orderid = tooo.orderid
		      WHERE em.branch_id = #{branchId}
			  AND (tod.dishtype &lt;> 2 or (tod.primarykey &lt;> tod.superkey and tod.dishtype = 2))
			  GROUP BY tooo.userid 
			)AS S1
		LEFT JOIN 
			(SELECT ttoo.userid as waiterId,SUM(ttoo.custnum) AS custNum FROM t_order ttoo 
			 WHERE ttoo.branchid = #{branchId}
			 AND ttoo.begintime >= #{beginTime}
			 AND ttoo.begintime &lt;= #{endTime}
			 AND ttoo.orderstatus=3
			 <if test=" userid != null and userid!='' ">
	      	 AND ttoo.userid =#{userid}
	   		 </if>
	    	 <if test="shiftid !=null and shiftid!=-1">
			 AND ttoo.shiftid = #{shiftid}
			 </if>
			 GROUP BY ttoo.userid
			) AS S2 
		ON S1.waiterId = S2.waiterId
		order by S1.waiterId
    </select>

    <select id="getWaiterShiftInfo" parameterType="java.util.Map"  resultType="java.util.Map">
        SELECT ord.orderid,ord.userid,ord.custnum,us.`name`,sum(ordt.dishnum*ordt.orignalprice) as shouldamount,
		tab.tableNo as tableids, t.xj,
		t.yhk,
		t.ml,
		t.hykxf,
		t.hyjfxf,
		t.gz2,
		t.wxzf,
		t.zfbzf from t_order ord LEFT JOIN t_order_detail ordt ON ord.orderid = ordt.orderid
		left join t_b_employee em on ord.userid = em.job_number left join t_b_user us on us.id = em.user_id
		LEFT JOIN t_table tab ON tab.tableid = ord.currenttableid LEFT JOIN (SELECT
		orderid,
		MAX(CASE payway WHEN 0 THEN payamount ELSE 0 END )    xj,
		MAX(CASE payway WHEN 1 THEN payamount ELSE 0 END )    yhk,
		MAX(CASE payway WHEN 7 THEN payamount ELSE 0 END )    ml,
		MAX(CASE payway WHEN 8 THEN payamount ELSE 0 END )    hykxf,
		MAX(CASE payway WHEN 11 THEN payamount ELSE 0 END )    hyjfxf,
		(SUM(CASE payway WHEN 5 THEN payamount ELSE 0 END )  +SUM(CASE payway WHEN 13 THEN payamount ELSE 0 END ) )   gz2,
		(MAX(CASE payway WHEN 17 THEN payamount ELSE 0 END ) +MAX(CASE payway WHEN 30 THEN payamount ELSE 0 END ))    wxzf,
		MAX(CASE payway WHEN 18 THEN payamount ELSE 0 END )    zfbzf
		FROM t_settlement_detail GROUP BY orderid) t ON ord.orderid = t.orderid
        where ord.begintime &gt;= #{beginTime} and ord.begintime &lt;= #{endTime}  and (ordt.primarykey &lt;&gt; ordt.superkey or ordt.ordertype &lt;&gt; 2) and em.branch_id = #{branchId} and ord.branchid = #{branchId}
        and ord.orderstatus=3
		<if test="shiftid==-1">
	      and  ord.shiftid in (0,1)
	    </if>
	    <if test="shiftid!=-1">
	      and  ord.shiftid =#{shiftid}
	    </if>
	    <if test=" userid != null and userid!='' ">
	      and  ord.userid =#{userid}
	    </if>
	    group by ord.orderid
    </select>
    
    <select id="getOrderPayMount" parameterType="java.util.Map"  resultType="java.util.Map">
       select ord.orderid,sum(setd.payamount) as paidinamount from t_order ord left join t_settlement_detail setd on ord.orderid = setd.orderid where setd.payway in (0,1,5,8,13,17,18,30)
       and ord.begintime &gt;= #{beginTime} and ord.begintime &lt;= #{endTime} and ord.branchid = #{branchId}  and ord.orderstatus=3
        <if test="shiftid==-1">
	      and  ord.shiftid in (0,1)
	    </if>
	    <if test="shiftid!=-1">
	      and  ord.shiftid =#{shiftid}
	    </if>
	    <if test=" userid != null and userid!='' ">
	      and  ord.userid =#{userid}
	    </if>
       group by ord.orderid
    </select>
    
    <select id="getOrderInflated" parameterType="java.util.Map"  resultType="java.util.Map">
      SELECT ord.orderid, sum(mem.Inflated) as inflated from t_order ord LEFT JOIN t_order_member mem ON ord.orderid = mem.orderid
       where ord.begintime &gt;= #{beginTime} and ord.begintime &lt;= #{endTime} and ord.branchid = #{branchId}  and ord.orderstatus=3
        <if test="shiftid==-1">
	      and  ord.shiftid in (0,1)
	    </if>
	    <if test="shiftid!=-1">
	      and  ord.shiftid =#{shiftid}
	    </if>
	   <if test=" userid != null and userid!='' ">
	      and  ord.userid =#{userid}
	    </if>
	    GROUP BY
		ord.orderid;
    </select>
</mapper>