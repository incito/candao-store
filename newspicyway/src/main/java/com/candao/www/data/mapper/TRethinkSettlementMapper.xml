<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.candao.www.data.dao.TRethinkSettlementDao">

    <!-- 查询反结算前数据 -->
	<select id="queryRethinkSettlementBefore" parameterType="map" resultType="map">
	    SELECT
		  	tsdh.orderid,
			too.endtime as before_cleartime,
			(select IFNULL(sum(tod.dishnum*tod.orignalprice),0) from t_order_detail_history tod where tod.orderid = too.orderid)
			+too.dueamount-(select IFNULL(sum(payamount),0)  from t_order_detail_history where   status!=5 and  orderid=tsh.orderid  )
			-(SELECT IFNULL(sum(dishnum*orignalprice),0) FROM t_order_detail_history WHERE orderid = too.orderid and dishtype = 2 and superkey = primarykey) as before_shouldamount,
			IFNULL(sum(tsdh.payamount),0)-IFNULL(tsh.Inflated,0) as before_paidamount,
			too.userid as waiter,
			tsh.userid as cashier,
			tsh.authorizer_name
		FROM
			t_settlement_detail_history tsdh,
			t_order_history too,
		    t_settlement_history tsh
		WHERE
			tsdh.orderid = too.orderid
		AND tsdh.orderid = tsh.orderid
		AND too.branchid = #{branchId}
        <if test="beginTime!=null and beginTime!='' and endTime!=null and endTime!='' ">
            AND too.endtime BETWEEN str_to_date(#{beginTime},'%Y-%m-%d %H:%i:%s') AND str_to_date(#{endTime},'%Y-%m-%d %H:%i:%s')
        </if>
        AND tsh.reason not like '%??????%'
        AND tsh.reason not like '%会员结算失败%'
        AND tsdh.payway in (SELECT itemid FROM v_revenuepayway)
		AND too.orderstatus = 3
        group by tsdh.orderid
	</select>
    
    <!-- 查询反结算后数据 -->
    <!-- <select id="queryRethinkSettlementAfter" parameterType="map" resultType="map">
        SELECT
		  	tsd.orderid,
			too.endtime as after_cleartime,
			(select IFNULL(sum(tod.dishnum*tod.orignalprice),0) from t_order_detail tod where tod.orderid = too.orderid)
			-(SELECT IFNULL(sum(dishnum*orignalprice),0) FROM t_order_detail_history WHERE orderid = too.orderid and dishtype = 2 and superkey = primarykey and orderid = #{orderid}) as after_shouldamount,
			IFNULL(sum(tsd.payamount),0) as after_paidamount,
			ts.userid as cashier
		FROM
			t_settlement_detail tsd,
			t_order too,
		    t_settlement ts
		WHERE
			tsd.orderid = too.orderid
		AND tsd.orderid = ts.orderid
		AND tsd.payway in (SELECT itemid FROM v_revenuepayway)
		AND tsd.orderid = #{orderid}
    </select> -->
    <select id="queryRethinkSettlementAfter" parameterType="map" resultType="map">
        SELECT
		  	tsd.orderid,
			too.endtime as after_cleartime,
			(select IFNULL(sum(tod.dishnum*tod.orignalprice),0) from t_order_detail tod where tod.orderid = too.orderid)
			+(SELECT IFNULL(sum(chargeAmount),0) FROM t_service_charge where orderid=#{orderid} and chargeOn=1)
			-(SELECT IFNULL(sum(dishnum*orignalprice),0) FROM t_order_detail WHERE orderid = too.orderid and dishtype = 2 and superkey = primarykey and orderid = #{orderid}) as after_shouldamount,
			IFNULL(sum(tsd.payamount),0) as after_paidamount,
			ts.userid as cashier
		FROM
			t_settlement_detail tsd,
			t_order too,
		    t_settlement ts
		WHERE
			tsd.orderid = too.orderid
		AND tsd.orderid = ts.orderid
		AND tsd.payway in (SELECT itemid FROM v_revenuepayway)
		AND tsd.orderid = #{orderid}
    </select>
    <!-- 查询用户名 -->
    <select id="queryUserNameByJobNumber" parameterType="map" resultType="String">
        select name from t_b_employee tbe,t_b_user tbu where tbe.user_id = tbu.id
        <if test="branchId != null and branchId != ''">
           and tbe.branch_id = #{branchId}
        </if> 
         and job_number = #{userId}
    </select>
    
    <!-- 查询订单基本信息 -->
    <select id="queryOrder" parameterType="map" resultType="map">
        SELECT
		    too.orderid,
			IFNULL(too.custnum,0) as personnum,
			DATE_FORMAT(too.begintime,'%Y-%m-%d %H:%i:%s') as begintime,
			DATE_FORMAT(too.endtime,'%Y-%m-%d %H:%i:%s') as endtime,
			tt.tableNo as tableno,
			tta.areaname as area,
		    too.userid
		FROM
			t_order too,
			t_table tt,
			t_tablearea tta
		WHERE
			too.currenttableid = tt.tableid
		AND tt.areaid = tta.areaid
        <if test="orderid!=null and orderid!=''">
            AND too.orderid = #{orderid}
        </if>
    </select>
    
    <!-- 查询订单详情 -->
    <select id="queryOrderDetail" parameterType="map" resultType="map">
        SELECT
			td.title AS itemdesc,
			sum(tod.dishnum) AS count,
			tod.dishunit AS dishunit,
			IFNULL(round(tod.orderprice,2), 0.00) AS price,
			IFNULL(round(tod.orderprice * sum(tod.dishnum),2),0.00)  AS amount
		FROM
			t_order_detail tod,
			t_dish td
		WHERE
			tod.dishid = td.dishid
	    <if test="orderid!=null and orderid!=''">
            AND tod.orderid = #{orderid}
        </if>
        group by tod.dishid,tod.dishunit,tod.orderprice
		UNION ALL
		SELECT '服务费',1,'',0,chargeAmount FROM t_service_charge where orderid = #{orderid} AND chargeOn=1
    </select>
    
    <!-- 查询优惠信息 -->
    <select id="queryPreferenceDetail" parameterType="map" resultType="map">
        SELECT
			IFNULL(a.bankcardno,'') AS bankcardno,
			IFNULL(sum(payamount),0) AS amount,
			itemDesc AS name
		FROM
			t_settlement_detail a
		LEFT JOIN (
			SELECT
				itemid,
				itemDesc
			FROM
				t_dictionary
			WHERE
				type = 'PAYWAY'
		) b ON (a.payway = b.itemid)
		WHERE
			a.payway <![CDATA[ <> ]]> 7
		AND a.payamount <![CDATA[ <> ]]> 0
		AND a.payway <![CDATA[ <> ]]> 20
		<if test="orderid!=null and orderid!=''">
            AND a.orderid = #{orderid}
        </if>
		GROUP BY
			orderid,
			couponNum,
			incometype,
			payway,
			itemDesc,
			membercardno,
			bankcardno
    </select>
        
    <!-- 查询结算信息 -->
    <select id="prosettlementDetail" parameterType="java.util.Map" statementType="CALLABLE" resultType="java.util.Map">
       {
          call p_report_jzd(
            #{orderid,jdbcType=VARCHAR,mode=IN},
            #{result,jdbcType=VARCHAR,mode=OUT}
          )
        }
    </select>
    
    <!-- 查询桌号 -->
    <select id="queryTableNo" resultType="String" parameterType="map">
        SELECT
			tt.tableNo
		FROM
			t_order too,
			t_table tt,
			t_tablearea tta
		WHERE 
			too.currenttableid = tt.tableid
		AND tt.areaid = tta.areaid
		<if test="orderid!=null and orderid!=''">
            AND too.orderid = #{orderid}
        </if>
    </select>
    
    <!-- 查询会员消费虚增 -->
    <select id="queryMemberInflate" resultType="BigDecimal" parameterType="map" >
        select Inflated from t_order_member where orderid = #{orderid}
    </select>
    
    <!-- 查询零头处理方式 -->
    <select id="queryLingtou" resultType="map" parameterType="map">
        select count(1) as count,payway,payamount from t_settlement_detail where orderid = #{orderid} and payway in (7,20);
    </select>
</mapper>