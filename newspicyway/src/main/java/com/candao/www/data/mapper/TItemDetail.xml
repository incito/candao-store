<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.candao.www.data.dao.TItemDetailDao">
    <!-- 查询品项销售明细总表存储过程 -->
    <select id="itemDetailProcedure" parameterType="java.util.Map" statementType="CALLABLE" resultType="java.util.Map">
        {
          call p_report_pxxsmxb(
            #{branchId,jdbcType=INTEGER,mode=IN},
            #{shiftid,jdbcType=INTEGER,mode=IN},
            #{beginTime,jdbcType=TIMESTAMP,mode=IN},
            #{endTime,jdbcType=TIMESTAMP,mode=IN},
            #{id,jdbcType=VARCHAR,mode=IN},
            #{dishType,jdbcType=VARCHAR,mode=IN},
            #{result,jdbcType=VARCHAR,mode=OUT}
          )
        }
    </select>
    <select id="itemDetailProcedureForPos" parameterType="java.util.Map" resultType="java.util.Map">
    	SELECT SUM(tod.orignalprice*tod.dishnum) AS orignalprice,
			tb.itemDesc AS itemDesc
		FROM t_order_detail tod ,t_order too,t_dish td,t_basicdata tb
		WHERE too.orderid = tod.orderid
		AND tb.id = (SELECT tdd.columnid FROM t_dish_dishtype tdd WHERE tdd.dishid = td.dishid LIMIT 1)
		AND td.dishid = tod.dishid
		AND too.begintime >= #{beginTime}
		AND too.begintime &lt;= #{endTime}
		AND too.orderstatus = 3
		AND too.branchid = ${branchId}
		<if test="shiftid != null and shiftid != -1">
		AND too.shiftid = #{shiftid}
		</if>
		AND( tod.dishtype!= 2 OR (tod.dishtype=2 AND tod.superkey= tod.primarykey))
		GROUP BY tb.id
		
UNION
	SELECT IFNULL(SUM(chargeAmount),0) AS orignalprice,
					'服务费' as itemDesc
		FROM t_service_charge a,t_order b 
	WHERE a.orderid=b.orderid 
	AND b.orderstatus = 3 
	AND a.chargeOn=1
	AND b.begintime >= #{beginTime}
	AND b.begintime &lt;= #{endTime}
	<if test="shiftid != null and shiftid != -1">
		AND b.shiftid = #{shiftid}
	</if>
	AND b.branchid = #{branchId}
UNION
	SELECT IFNULL(SUM(tod_c.dishnum*tod_c.orignalprice),0) as orignalprice,
		'餐具' as itemDesc
	FROM t_order_detail tod_c,t_order too_c
	WHERE tod_c.dishid = 'DISHES_98'
	AND tod_c.orderid = too_c.orderid
	AND too_c.orderstatus = 3 
	AND too_c.begintime >= #{beginTime}
	AND too_c.begintime &lt;= #{endTime}
	<if test="shiftid != null and shiftid != -1">
		AND too_c.shiftid = #{shiftid}
	</if>
	AND too_c.branchid = #{branchId}
    </select>
    <!-- 查询品项销售明细子表存储过程 -->
    <select id="itemSubDetailProcedure" parameterType="java.util.Map" statementType="CALLABLE" resultType="java.util.Map">
        {
          call p_report_pxxsmxb_zhixiang(
            #{branchId,jdbcType=INTEGER,mode=IN},
            #{shiftid,jdbcType=INTEGER,mode=IN},
            #{beginTime,jdbcType=TIMESTAMP,mode=IN},
            #{endTime,jdbcType=TIMESTAMP,mode=IN},
            #{id,jdbcType=VARCHAR,mode=IN},
            #{dishType,jdbcType=VARCHAR,mode=IN},
            0,
            #{result,jdbcType=VARCHAR,mode=OUT}
          )
        }
    </select>
    <!-- 查询品类 -->
    <select id="getItemDescList" resultType="map">
        select id,itemDesc from t_basicdata where status = 1 group by id
    </select>
    <!-- 查询门店名称 -->
    <select id="getBranchName" resultType="String" parameterType="String">
        select branchname from t_branch_info where branchid = #{branchid}
    </select>
</mapper>