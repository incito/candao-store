<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.candao.www.data.dao.TorderDetailPreferentialDao">
	<resultMap id="TorderDetailPreferentialID"
		type="com.candao.www.data.model.TorderDetailPreferential">
		<result property="id" column="id" jdbcType="VARCHAR" />
		<result property="orderid" column="orderid" jdbcType="VARCHAR" />
		<result property="preferential" column="preferential" jdbcType="VARCHAR" />
		<result property="deAmount" column="deAmount" jdbcType="DECIMAL" />
		<result property="discount" column="discount" jdbcType="DECIMAL" />
		<result property="isCustom" column="isCustom" jdbcType="TINYINT" />
		<result property="isGroup" column="isGroup" jdbcType="TINYINT" />
		<result property="insertime" column="insertime" jdbcType="TIMESTAMP" />
		<result property="preType" column="preType" jdbcType="VARCHAR" />
		<result property="preName" column="preName" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="base_result_map"
		type="com.candao.www.data.model.TbPreferentialActivity">
		<id column="id" property="id" jdbcType="VARCHAR" />
		<result column="code" property="code" jdbcType="CHAR" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="name_first_letter" property="nameFirstLetter"
			jdbcType="CHAR" />
		<result column="type" property="type" jdbcType="VARCHAR" />
		<result column="type_name" property="typeName" jdbcType="VARCHAR" />
		<result column="subtable_name" property="subtableName"
			jdbcType="VARCHAR" />
		<result column="sub_type" property="subType" jdbcType="VARCHAR" />
		<result column="sub_type_name" property="subTypeName" jdbcType="VARCHAR" />
		<result column="color" property="color" jdbcType="VARCHAR" />
		<result column="starttime" property="starttime" jdbcType="TIMESTAMP" />
		<result column="endtime" property="endtime" jdbcType="TIMESTAMP" />
		<result column="apply_all" property="applyAll" jdbcType="BOOLEAN" />
		<result column="activity_introduction" property="activityIntroduction"
			jdbcType="VARCHAR" />
		<result column="use_notice" property="useNotice" jdbcType="VARCHAR" />
		<result column="createtime" property="createtime" jdbcType="TIMESTAMP" />
		<result column="creator" property="creator" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap type="com.candao.www.data.model.TbOrderDetailPreInfo"
		id="base_orderdetail_PreInfo">
		<result column="todid" property="id" jdbcType="VARCHAR" />
		<result column="ordpreid" property="ordpreid" jdbcType="VARCHAR" />
		<result column="orderid" property="orderid" jdbcType="VARCHAR" />
		<result column="orderidetailid" property="orderidetailid"
			jdbcType="VARCHAR" />
		<result column="dishID" property="dishID" jdbcType="VARCHAR" />
		<result column="unit" property="unit" jdbcType="VARCHAR" />
		<result column="dishNum" property="dishNum" jdbcType="DOUBLE" />
		<result column="depreamount" property="dePreAmount" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="associationDetailpreferInfo"
		type="com.candao.www.data.model.TorderDetailPreferential" extends="TorderDetailPreferentialID">
		<association property="activity"
			javaType="com.candao.www.data.model.TbPreferentialActivity"
			resultMap="base_result_map"></association>

		<collection property="detailPreInfos" javaType="java.util.List"
			resultMap="base_orderdetail_PreInfo">
		</collection>
	</resultMap>

	<insert id="addBatchorderPreInfo" parameterType="java.util.List">
		INSERT INTO
		`t_order_detail_pre_info` (
		`id`,
		`ordpreid`,
		`orderid`,
		`orderidetailid`,
		`dishID`,
		`unit`,
		`dishNum`,
		`depreamount`,
		`insettime`
		)
		VALUES
		<foreach collection="list" item="ordDetPre" index="index"
			separator=",">
			(
			#{ordDetPre.id,jdbcType=VARCHAR},
			#{ordDetPre.ordpreid,jdbcType=VARCHAR},
			#{ordDetPre.orderid,jdbcType=VARCHAR},
			#{ordDetPre.orderidetailid,jdbcType=VARCHAR},
			#{ordDetPre.dishID,jdbcType=VARCHAR},
			#{ordDetPre.unit,jdbcType=VARCHAR},
			#{ordDetPre.dishNum,jdbcType=DOUBLE},
			#{ordDetPre.dePreAmount,jdbcType=DECIMAL},
			#{ordDetPre.insettime,jdbcType=TIMESTAMP}
			)
		</foreach>
		ON DUPLICATE KEY UPDATE dePreAmount
		=VALUES(dePreAmount),orderidetailid=VALUES(orderidetailid),dishNum=VALUES(dishNum)
	</insert>

	<insert id="addBatchInfo" parameterType="java.util.List">
		INSERT INTO
		`t_order_detail_preferential` (
		`id`,
		`orderid`,
		`preferential`,
		`deAmount`,
		`discount`,
		`isCustom`,
		`isGroup`,
		`toalFreeAmount`,
		`toalDebitAmount`,
		`insertime`,
		`preType`,
		`preName`)
		VALUES
		<foreach collection="list" item="ordDetPre" index="index"
			separator=",">
			(#{ordDetPre.id,jdbcType=VARCHAR},
			#{ordDetPre.orderid,jdbcType=VARCHAR},
			#{ordDetPre.preferential,jdbcType=VARCHAR},
			#{ordDetPre.deAmount,jdbcType=DECIMAL},
			#{ordDetPre.discount,jdbcType=DECIMAL},
			#{ordDetPre.isCustom,jdbcType=DECIMAL},
			#{ordDetPre.isGroup,jdbcType=TINYINT},
			#{ordDetPre.toalFreeAmount,jdbcType=VARCHAR},
			#{ordDetPre.toalDebitAmount,jdbcType=VARCHAR},
			#{ordDetPre.insertime,jdbcType=TIMESTAMP},
			#{ordDetPre.preType,jdbcType=VARCHAR},
			#{ordDetPre.preName,jdbcType=VARCHAR})
		</foreach>
		ON DUPLICATE KEY UPDATE deAmount
		=VALUES(deAmount),isGroup=VALUES(isGroup),discount=VALUES(discount),toalFreeAmount=VALUES(toalFreeAmount),toalDebitAmount=VALUES(toalDebitAmount)
	</insert>


	<delete id="deleteDetilPreFerInfo" parameterType="map">
		DELETE FROM t_order_detail_preferential WHERE
		orderid=#{orderid}
		<if test='clear != null and clear=="0"'>
			and id=#{DetalPreferentiald,jdbcType=VARCHAR}
		</if>
	</delete>

	<delete id="deleteDetileSubPreInfo" parameterType="map">
		DELETE FROM t_order_detail_pre_info WHERE
		orderid=#{orderid}
		<if test='clear != null and clear=="0"'>
			and ordpreid=#{DetalPreferentiald,jdbcType=VARCHAR}
		</if>
	</delete>

	<delete id="deleteSubPreInfo">
		DELETE FROM t_order_detail_pre_info WHERE
		orderid=#{orderid} and ordpreid=#{ordpreid}
	</delete>


	<delete id="deleteForXinladaoInfo" parameterType="map">
		DELETE FROM
		t_order_detail_preferential WHERE
		orderid=#{orderid} and
		isCustom=#{custom};
	</delete>

	<select id="getTorderDetailPreS" parameterType="map"
		resultType="com.candao.www.data.model.TorderDetailPreferential">
		SELECT * FROM t_order_detail_preferential todp WHERE
		todp.orderid=#{orderid} AND todp.isGroup=0;
	</select>
	<select id="queryDetailPreByGift" parameterType="map"
		resultType="com.candao.www.data.model.TorderDetailPreferential">
		SELECT * FROM t_order_detail_preferential todp WHERE
		todp.orderid=#{orderid} AND todp.isGroup=0 AND
		todp.isCustom=4;
	</select>

	<!-- 菜品单个优惠挂钩优惠卷 -->
	<select id="queryGiveprefer" parameterType="map" resultType="java.util.HashMap">
		SELECT
		COUNT(tordpi.id) AS count,
		tordpi.dishid,
		tordpi.unit
		FROM
		t_order_detail_preferential AS top
		LEFT JOIN t_order_detail_pre_info as
		tordpi
		ON
		top.id =tordpi.ordpreid
		WHERE
		top.orderid =#{orderid}
		AND
		(isCustom = 4
		OR
		isCustom=3)
		GROUP BY
		tordpi.dishid,tordpi.unit;
	</select>
	<select id="getTorderDetailSbyOrderid" parameterType="map"
		resultMap="associationDetailpreferInfo">
		SELECT
		todp.*, tpp.type,
		tpp. NAME,
		tpp.sub_type,
		todpi.dishID,
		todpi.dishNum,
		todpi.id AS todid,
		todpi.orderidetailid,
		todpi.unit,
		todpi.depreamount
		FROM
		t_order_detail_preferential AS todp
		LEFT JOIN
		t_p_preferential_activity tpp ON todp.preferential = tpp.id
		LEFT JOIN
		t_order_detail_pre_info AS todpi ON todp.id = todpi.ordpreid
		WHERE
		todp.orderid = #{orderid}
		ORDER BY
		todp.insertime ASC;
	</select>
	<select id="statisticALLDiscount" parameterType="map"
		resultType="java.math.BigDecimal">
		SELECT IFNULL(SUM(deAmount) ,0) FROM
		t_order_detail_preferential WHERE orderid=#{orderid};
	</select>
	<!-- 查询特价卷以及赠菜卷优惠 -->
	<select id="getPresentAndspecialPriclist" parameterType="map"
		resultMap="associationDetailpreferInfo">
		SELECT
		todp.*, tpp.type,
		tpp. NAME,
		tpp.sub_type,
		todpi.dishID,
		todpi.dishNum,
		todpi.id AS todid,
		todpi.orderidetailid,
		todpi.unit,
		todpi.depreamount,
		todpi.ordpreid
		FROM
		t_order_detail_preferential AS
		todp
		LEFT JOIN
		t_p_preferential_activity tpp ON todp.preferential =
		tpp.id
		LEFT JOIN
		t_order_detail_pre_info AS todpi ON todp.id =
		todpi.ordpreid
		WHERE
		todp.orderid = #{orderid}
		AND (isCustom = 3 OR
		isCustom = 4)
		ORDER BY
		todp.insertime ASC;
	</select>

	<!-- 查询所有优惠信息 -->
	<select id="getAllPreInfolist" parameterType="map"
		resultMap="associationDetailpreferInfo">
		SELECT
		todp.*, tpp.type,
		tpp. NAME,
		tpp.sub_type,
		todpi.dishID,
		todpi.dishNum,
		todpi.id AS todid,
		todpi.orderidetailid,
		todpi.unit,
		todpi.depreamount,
		todpi.ordpreid
		FROM
		t_order_detail_preferential AS
		todp
		LEFT JOIN
		t_p_preferential_activity tpp ON todp.preferential =
		tpp.id
		LEFT JOIN
		t_order_detail_pre_info AS todpi ON todp.id =
		todpi.ordpreid
		WHERE
		todp.orderid = #{orderid}
		ORDER BY
		todp.insertime
		ASC;
	</select>


</mapper>